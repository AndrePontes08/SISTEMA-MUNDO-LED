{% extends "base.html" %}
{% load formatters %}

{% block title %}Compra #{{ compra.id }}{% endblock %}
{% block page_title %}Compra #{{ compra.id }}{% endblock %}

{% block content %}
<style>
  .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 1px 10px rgba(0,0,0,.06); }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:left; }
  .muted { color:#6b7280; font-size:13px; }
  .btn { display:inline-block; padding:8px 12px; border-radius:10px; background:#111827; color:#fff; text-decoration:none; border:none; cursor:pointer; }
  .btn-outline { background:#fff; color:#111827; border:1px solid #d1d5db; }
  .btn-success { background:#065f46; }
  .btn-danger { background:#991b1b; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .analysis-box { margin-top:14px; padding:14px; border:1px solid #dbeafe; border-radius:12px; background:#f8fbff; }
  .analysis-title { margin:0 0 8px 0; font-size:16px; }
  .analysis-grid { display:grid; gap:8px; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); }
  .analysis-item { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; }
  .analysis-item-title { font-size:13px; color:#374151; margin-bottom:6px; }
  .status-chip { display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; }
  .status-ok { background:#dcfce7; color:#166534; }
  .status-missing { background:#fee2e2; color:#991b1b; }
  .actions-row { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
</style>

<div class="card">
  <div class="row">
    <div>
      <h2 style="margin:0;">{{ compra.fornecedor.nome }}</h2>
      <div class="muted">{{ compra.data_compra|date:"d/m/Y" }} - Centro: {{ compra.centro_custo }} - Total: {{ compra.valor_total|br_currency }}</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a class="btn" href="{% url 'compras:compra_update' compra.id %}">Editar</a>
      <a class="btn" href="/estoque/entrada/compra/{{ compra.id }}/">Entrada no estoque</a>
      {% if can_approve and compra.status == 'SOLICITADA' %}
      <form method="post" action="{% url 'compras:compra_aprovar' compra.id %}" style="display:inline">{% csrf_token %}<button type="submit" class="btn btn-success">Aprovar compra</button></form>
      {% endif %}
      {% if compra.status == 'APROVADA' %}
      <a class="btn" href="{% url 'estoque:recebimento_detail' compra.id %}">Receber no estoque</a>
      {% endif %}
      <a class="btn" href="{% url 'compras:garantia_create' %}">Nova garantia</a>
    </div>
  </div>

  <div class="analysis-box">
    <h3 class="analysis-title">Analise de orcamentos</h3>
    <div class="analysis-grid">
      <div class="analysis-item">
        <div class="analysis-item-title">Orcamento 1</div>
        {% if compra.orcamento_1 %}
          <span class="status-chip status-ok">Anexo enviado</span>
          <div class="actions-row">
            <a class="btn btn-outline" href="{% url 'compras:compra_download_file' compra.id 'orc1' %}">Baixar Orcamento 1</a>
          </div>
        {% else %}
          <span class="status-chip status-missing">Sem anexo</span>
        {% endif %}
      </div>

      <div class="analysis-item">
        <div class="analysis-item-title">Orcamento 2</div>
        {% if compra.orcamento_2 %}
          <span class="status-chip status-ok">Anexo enviado</span>
          <div class="actions-row">
            <a class="btn btn-outline" href="{% url 'compras:compra_download_file' compra.id 'orc2' %}">Baixar Orcamento 2</a>
          </div>
        {% else %}
          <span class="status-chip status-missing">Sem anexo</span>
        {% endif %}
      </div>

      <div class="analysis-item">
        <div class="analysis-item-title">Orcamento 3</div>
        {% if compra.orcamento_3 %}
          <span class="status-chip status-ok">Anexo enviado</span>
          <div class="actions-row">
            <a class="btn btn-outline" href="{% url 'compras:compra_download_file' compra.id 'orc3' %}">Baixar Orcamento 3</a>
          </div>
        {% else %}
          <span class="status-chip status-missing">Sem anexo</span>
        {% endif %}
      </div>
    </div>

    <div style="margin-top:10px;" class="muted">
      <strong>Orcamento escolhido:</strong> {{ compra.get_orcamento_escolhido_display|default:"-" }}
    </div>
    <div class="muted"><strong>Justificativa:</strong> {{ compra.justificativa_escolha|default:"-" }}</div>
    <div class="muted"><strong>Observacoes:</strong> {{ compra.observacoes|default:"-" }}</div>
  </div>

  <div style="margin-top:12px;">
    {% if compra.nota_fiscal %}<p class="muted">Nota fiscal: <a href="{% url 'compras:compra_download_file' compra.id 'nota' %}">baixar</a></p>{% endif %}
    {% if compra.boleto %}<p class="muted">Boleto: <a href="{% url 'compras:compra_download_file' compra.id 'boleto' %}">baixar</a></p>{% endif %}
    {% if compra.pedido %}<p class="muted">Pedido/Orcamento: <a href="{% url 'compras:compra_download_file' compra.id 'pedido' %}">baixar</a></p>{% endif %}
    {% if compra.comprovante_pagamento %}<p class="muted">Comprovante: <a href="{% url 'compras:compra_download_file' compra.id 'comprovante' %}">baixar</a></p>{% endif %}
  </div>

  <h3>Itens</h3>
  <table>
    <thead><tr><th>Produto</th><th>Qtd</th><th>R$ Unit</th><th>Subtotal</th><th>Garantias</th></tr></thead>
    <tbody>
    {% for it in compra.itens.all %}
      <tr>
        <td>{{ it.produto.nome }}</td><td>{{ it.quantidade|br_number:3 }}</td><td>{{ it.preco_unitario|br_currency }}</td><td>{{ it.subtotal|br_currency }}</td>
        <td>{% if it.garantias.all %}{% for g in it.garantias.all %}<div class="muted">Ate {{ g.data_fim|date:"d/m/Y" }} {% if g.arquivo %}- <a href="{{ g.arquivo.url }}">arquivo</a>{% endif %}</div>{% endfor %}{% else %}<span class="muted">-</span>{% endif %}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
