{% extends "base.html" %}
{% load formatters %}

{% block title %}Compra #{{ compra.id }}{% endblock %}
{% block page_title %}Compra #{{ compra.id }}{% endblock %}

{% block content %}
<div class="card">
  <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:start;">
    <div>
      <h2 style="margin:0;">{{ compra.fornecedor.nome }}</h2>
      <div class="muted">{{ compra.data_compra|date:"d/m/Y" }} | Centro: {{ compra.centro_custo }} | Total: {{ compra.valor_total|br_currency }}</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a class="btn btn-secondary" href="{% url 'compras:compra_update' compra.id %}">Editar</a>
      <a class="btn" href="/estoque/entrada/compra/{{ compra.id }}/">Entrada no estoque</a>
      {% if can_approve and compra.status == 'SOLICITADA' %}
      <form method="post" action="{% url 'compras:compra_aprovar' compra.id %}" style="display:inline">{% csrf_token %}<button type="submit" class="btn">Aprovar compra</button></form>
      {% endif %}
      {% if compra.status == 'APROVADA' %}
      <a class="btn" href="{% url 'estoque:recebimento_detail' compra.id %}">Receber no estoque</a>
      {% endif %}
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin-top:0;">Análise de orçamentos</h3>
  <div style="display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
    <div class="tile">
      <strong>Orçamento 1</strong><br>
      {% if compra.orcamento_1 %}<span class="muted">Anexo enviado</span><br><a href="{% url 'compras:compra_download_file' compra.id 'orc1' %}">Baixar</a>{% else %}<span class="muted">Sem anexo</span>{% endif %}
    </div>
    <div class="tile">
      <strong>Orçamento 2</strong><br>
      {% if compra.orcamento_2 %}<span class="muted">Anexo enviado</span><br><a href="{% url 'compras:compra_download_file' compra.id 'orc2' %}">Baixar</a>{% else %}<span class="muted">Sem anexo</span>{% endif %}
    </div>
    <div class="tile">
      <strong>Orçamento 3</strong><br>
      {% if compra.orcamento_3 %}<span class="muted">Anexo enviado</span><br><a href="{% url 'compras:compra_download_file' compra.id 'orc3' %}">Baixar</a>{% else %}<span class="muted">Sem anexo</span>{% endif %}
    </div>
  </div>
  <p style="margin-top:10px;"><strong>Escolhido:</strong> {{ compra.get_orcamento_escolhido_display|default:"-" }}</p>
  <p><strong>Justificativa:</strong> {{ compra.justificativa_escolha|default:"-" }}</p>
  <p><strong>Observações:</strong> {{ compra.observacoes|default:"-" }}</p>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin-top:0;">Outros anexos</h3>
  <ul>
    {% if compra.nota_fiscal %}<li>Nota fiscal: <a href="{% url 'compras:compra_download_file' compra.id 'nota' %}">baixar</a></li>{% endif %}
    {% if compra.boleto %}<li>Boleto: <a href="{% url 'compras:compra_download_file' compra.id 'boleto' %}">baixar</a></li>{% endif %}
    {% if compra.pedido %}<li>Pedido/Orçamento: <a href="{% url 'compras:compra_download_file' compra.id 'pedido' %}">baixar</a></li>{% endif %}
    {% if compra.comprovante_pagamento %}<li>Comprovante: <a href="{% url 'compras:compra_download_file' compra.id 'comprovante' %}">baixar</a></li>{% endif %}
  </ul>
</div>

<div class="card" style="margin-top:12px;">
  <h3 style="margin-top:0;">Itens</h3>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead><tr><th>Produto</th><th>Qtd</th><th>R$ Unit.</th><th>Subtotal</th><th>Garantias</th></tr></thead>
      <tbody>
      {% for it in compra.itens.all %}
        <tr>
          <td>{{ it.produto.nome }}</td>
          <td>{{ it.quantidade|br_number:0 }}</td>
          <td>{{ it.preco_unitario|br_currency }}</td>
          <td><strong>{{ it.subtotal|br_currency }}</strong></td>
          <td>{% if it.garantias.all %}{% for g in it.garantias.all %}<div class="muted">Até {{ g.data_fim|date:"d/m/Y" }} {% if g.arquivo %}- <a href="{{ g.arquivo.url }}">arquivo</a>{% endif %}</div>{% endfor %}{% else %}<span class="muted">-</span>{% endif %}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
