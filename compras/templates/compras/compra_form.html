{% extends "base.html" %}

{% block title %}{% if object %}Editar{% else %}Nova{% endif %} Compra{% endblock %}
{% block page_title %}{% if object %}Editar{% else %}Nova{% endif %} Compra{% endblock %}

{% block content %}
<div class="card">
  <form method="post" enctype="multipart/form-data" style="display:grid;gap:14px;">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="card" style="background:#f7fbff;">
      <h3 style="margin-top:0;">Dados da compra</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
        <div>
          <label>Fornecedor</label>
          {{ form.fornecedor }}
          {{ form.fornecedor.errors }}
        </div>
        <div style="display:flex;align-items:end;">
          <a class="btn btn-secondary" href="{% url 'compras:fornecedor_quick_create' %}?next={{ request.get_full_path|urlencode }}">+ Cadastrar fornecedor</a>
        </div>
        <div><label>Centro de custo</label>{{ form.centro_custo }}{{ form.centro_custo.errors }}</div>
        <div><label>Data</label>{{ form.data_compra }}{{ form.data_compra.errors }}</div>
      </div>
    </div>

    <div class="card" style="background:#f7fbff;">
      <h3 style="margin-top:0;">Anexos gerais</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
        <div><label>Nota fiscal</label>{{ form.nota_fiscal }}</div>
        <div><label>Boleto</label>{{ form.boleto }}</div>
        <div><label>Pedido/Orçamento</label>{{ form.pedido }}</div>
        <div><label>Comprovante de pagamento</label>{{ form.comprovante_pagamento }}</div>
      </div>
    </div>

    <div class="card" style="background:#f7fbff;">
      <h3 style="margin-top:0;">3 orçamentos obrigatórios</h3>
      <p class="muted">Esses anexos são usados no fluxo de aprovação.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
        <div><label>Orçamento 1</label>{{ form.orcamento_1 }}{{ form.orcamento_1.errors }}</div>
        <div><label>Orçamento 2</label>{{ form.orcamento_2 }}{{ form.orcamento_2.errors }}</div>
        <div><label>Orçamento 3</label>{{ form.orcamento_3 }}{{ form.orcamento_3.errors }}</div>
        <div><label>Orçamento escolhido</label>{{ form.orcamento_escolhido }}{{ form.orcamento_escolhido.errors }}</div>
        <div style="grid-column:1 / -1;"><label>Justificativa da escolha</label>{{ form.justificativa_escolha }}{{ form.justificativa_escolha.errors }}</div>
      </div>
    </div>

    <div class="card" style="background:#f7fbff;">
      <h3 style="margin-top:0;">Observações</h3>
      <label>Observações (obrigatório)</label>{{ form.observacoes }}{{ form.observacoes.errors }}
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;align-items:center;">
        <h3 style="margin:0;">Itens da compra</h3>
        <a class="btn btn-secondary" href="{% url 'compras:produto_quick_create' %}?next={{ request.get_full_path|urlencode }}">+ Cadastrar produto</a>
      </div>
      <p class="muted">Preencha quantidade e preço unitário para cada item.</p>
      {{ itens_formset.management_form }}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr><th>Produto</th><th>Quantidade</th><th>Preço unitário</th><th>Remover</th></tr></thead>
          <tbody>
          {% for f in itens_formset.forms %}
            <tr>
              <td>{{ f.id }}{{ f.produto }}{{ f.produto.errors }}</td>
              <td>{{ f.quantidade }}{{ f.quantidade.errors }}</td>
              <td>{{ f.preco_unitario }}{{ f.preco_unitario.errors }}</td>
              <td>{% if f.DELETE %}{{ f.DELETE }} <span class="muted">Excluir</span>{% else %}<span class="muted">-</span>{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" type="submit">Salvar compra</button>
      <a class="btn btn-secondary" href="{% url 'compras:compra_list' %}">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}
