{% extends "base.html" %}
{% load formatters %}

{% block title %}Contas{% endblock %}
{% block page_title %}Contas a Pagar{% endblock %}

{% block content %}
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
    <h2 style="margin:0;">Lista de contas</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <a href="{% url 'contas:conta_create' %}" class="btn">+ Nova Conta</a>
      <a href="{% url 'contas:import_csv' %}" class="btn">Importar CSV</a>
      <a href="{% url 'contas:dashboard' %}" class="btn btn-secondary">Dashboard</a>
    </div>
  </div>

  <form method="get" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;align-items:end;margin-top:12px;">
    <div><label>Descrição</label><input type="text" name="q" placeholder="Buscar..." value="{{ request.GET.q }}"></div>
    <div>
      <label>Status</label>
      <select name="status">
        <option value="">Todos</option>
        <option value="ABERTA" {% if request.GET.status == 'ABERTA' %}selected{% endif %}>Aberta</option>
        <option value="PAGA" {% if request.GET.status == 'PAGA' %}selected{% endif %}>Paga</option>
      </select>
    </div>
    <div><label>Centro</label><input type="text" name="centro_custo" placeholder="FM/ML..." value="{{ request.GET.centro_custo }}"></div>
    <div><label>Mês</label><input type="text" name="mes" placeholder="YYYY-MM" value="{{ request.GET.mes }}"></div>
    <div><button type="submit" class="btn">Filtrar</button></div>
  </form>

  <div class="table-responsive" style="margin-top:12px;">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Vencimento</th>
          <th>Descrição</th>
          <th>Centro</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for c in contas %}
          <tr>
            <td>{{ c.vencimento|date:"d/m/Y" }}</td>
            <td>{{ c.descricao }}</td>
            <td>{{ c.centro_custo }}</td>
            <td><strong>{{ c.valor|br_currency }}</strong></td>
            <td>{{ c.get_status_display }}{% if c.importado %} <span class="muted">(importado)</span>{% endif %}</td>
            <td><a href="{% url 'contas:conta_detail' c.id %}">Abrir</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="muted">Nenhuma conta encontrada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      {% if page_obj.has_previous %}
        <a class="btn btn-secondary" href="?page=1{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Primeira</a>
        <a class="btn btn-secondary" href="?page={{ page_obj.previous_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Anterior</a>
      {% endif %}

      <span><strong>{{ page_obj.paginator.count }}</strong> contas | Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

      <form method="get" style="display:flex;gap:4px;align-items:center;">
        <label>Itens</label>
        <select name="page_size" onchange="this.form.submit()" style="width:auto;">
          <option value="20" {% if request.GET.page_size == '20' or not request.GET.page_size %}selected{% endif %}>20</option>
          <option value="50" {% if request.GET.page_size == '50' %}selected{% endif %}>50</option>
          <option value="100" {% if request.GET.page_size == '100' %}selected{% endif %}>100</option>
        </select>
        {% if request.GET.q %}<input type="hidden" name="q" value="{{ request.GET.q }}">{% endif %}
        {% if request.GET.status %}<input type="hidden" name="status" value="{{ request.GET.status }}">{% endif %}
        {% if request.GET.centro_custo %}<input type="hidden" name="centro_custo" value="{{ request.GET.centro_custo }}">{% endif %}
        {% if request.GET.mes %}<input type="hidden" name="mes" value="{{ request.GET.mes }}">{% endif %}
      </form>

      {% if page_obj.has_next %}
        <a class="btn btn-secondary" href="?page={{ page_obj.next_page_number }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Próxima</a>
        <a class="btn btn-secondary" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.page_size %}&page_size={{ request.GET.page_size }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">Última</a>
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}
