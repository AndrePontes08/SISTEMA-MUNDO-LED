{% load static formatters %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="{% static 'core/img/logo_mundo_led.png' %}">
  <link rel="stylesheet" href="{% static 'core/css/app.css' %}">
  <title>{% block title %}MUNDO LED ERP{% endblock %}</title>
  <style>
    :root {
      --brand-900: #082349;
      --brand-800: #0f3a74;
      --brand-700: #1155cc;
      --brand-600: #1b66d8;
      --brand-500: #2c7df0;
      --brand-100: #dce9ff;
      --ink-900: #11213d;
      --ink-700: #2c3f60;
      --ink-500: #5f708d;
      --line: #dbe5f3;
      --surface: #f4f8ff;
      --paper: #ffffff;
      --success: #15803d;
      --warning: #b45309;
      --danger: #b91c1c;
      --info: #0c4a6e;
      --radius: 14px;
      --shadow-sm: 0 6px 18px rgba(17, 33, 61, 0.08);
      --shadow-md: 0 16px 34px rgba(17, 33, 61, 0.14);
    }

    * { box-sizing: border-box; }
    html { font-size: 16px; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Roboto", "Ubuntu", sans-serif;
      color: var(--ink-900);
      background:
        radial-gradient(circle at top right, #cfe0ff 0%, rgba(207, 224, 255, 0) 42%),
        linear-gradient(180deg, #f8fbff 0%, #eef4ff 100%);
      line-height: 1.45;
    }

    h1, h2, h3, h4, h5 { margin: 0 0 8px; line-height: 1.2; }
    p { margin: 0 0 10px; }
    a { color: var(--brand-700); }

    .layout {
      min-height: 100vh;
      display: flex;
    }

    .sidebar {
      width: 278px;
      background: linear-gradient(180deg, var(--brand-900) 0%, #071a37 100%);
      color: #edf3ff;
      padding: 16px 14px 18px;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 30;
      box-shadow: var(--shadow-md);
      transition: transform .22s ease;
    }

    .brand {
      min-height: 94px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      background: linear-gradient(160deg, rgba(44, 125, 240, 0.34), rgba(16, 33, 70, 0.38));
      display: grid;
      place-items: center;
      margin-bottom: 14px;
      letter-spacing: .08em;
      font-weight: 800;
      font-size: 1.2rem;
      text-align: center;
      padding: 10px;
    }

    .menu-group { margin-bottom: 14px; }
    .menu-title {
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .12em;
      opacity: .76;
      margin: 10px 8px;
      font-weight: 700;
    }

    .menu-accordion {
      border-radius: 11px;
      background: rgba(255, 255, 255, 0.05);
      margin-bottom: 6px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .menu-accordion > summary {
      list-style: none;
      cursor: pointer;
      padding: 10px 12px;
      font-weight: 700;
      font-size: .94rem;
      user-select: none;
    }

    .menu-accordion > summary::-webkit-details-marker { display: none; }
    .menu-accordion > summary:hover { background: rgba(255, 255, 255, 0.1); }
    .menu-accordion[open] > summary { background: rgba(255, 255, 255, 0.12); }

    .menu-children { padding: 5px 7px 7px; }
    .menu-link {
      display: block;
      color: #edf3ff;
      text-decoration: none;
      font-size: .93rem;
      font-weight: 600;
      border-radius: 9px;
      padding: 9px 11px;
      margin: 3px 0;
      transition: background .16s ease;
    }

    .menu-link:hover { background: rgba(255, 255, 255, 0.1); }
    .menu-link.active {
      background: linear-gradient(90deg, var(--brand-600), var(--brand-700));
      color: #fff;
      box-shadow: 0 8px 16px rgba(44, 125, 240, 0.34);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(5, 13, 28, 0.55);
      z-index: 20;
    }

    .content {
      flex: 1;
      margin-left: 278px;
      width: calc(100% - 278px);
      padding: 16px 22px 24px;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 12;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(8px);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 12px;
      padding: 10px 12px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu-toggle {
      display: none;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--ink-900);
      border-radius: 10px;
      font-weight: 700;
      padding: 8px 10px;
      cursor: pointer;
    }

    .muted { color: var(--ink-500); font-weight: 500; }

    .messages { margin-bottom: 12px; }
    .msg {
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 7px;
      border: 1px solid transparent;
      font-size: .92rem;
    }
    .msg.success { background: #ecfdf3; color: #14532d; border-color: #bbf7d0; }
    .msg.error { background: #fef2f2; color: #7f1d1d; border-color: #fecaca; }
    .msg.info { background: #eff6ff; color: #1e3a8a; border-color: #bfdbfe; }
    .msg.warning { background: #fffbeb; color: #78350f; border-color: #fde68a; }

    .card {
      background: var(--paper);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 16px;
    }

    .card-header {
      margin: -16px -16px 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      font-weight: 700;
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      background: #f8fbff;
    }

    .card-body { padding: 0; }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .tile { border: 1px solid var(--line); background: #f7faff; border-radius: 12px; padding: 12px; }

    table,
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: .95rem;
    }

    th, td,
    .table th,
    .table td {
      border-bottom: 1px solid #e6edf8;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    thead th,
    .table thead th {
      background: #f5f9ff;
      color: var(--ink-700);
      font-weight: 700;
    }

    .table-hover tbody tr:hover,
    .table tbody tr:hover {
      background: #f8fbff;
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid #cfd9ea;
      border-radius: 10px;
      padding: 10px 11px;
      min-height: 41px;
      background: #fff;
      color: var(--ink-900);
      font: inherit;
      font-weight: 500;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--brand-600);
      box-shadow: 0 0 0 3px rgba(44, 125, 240, .16);
    }

    textarea { min-height: 90px; }

    .btn,
    button.btn,
    .btn-link {
      display: inline-block;
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 9px 13px;
      font-size: .92rem;
      line-height: 1.2;
      font-weight: 700;
      text-decoration: none;
      cursor: pointer;
      background: linear-gradient(180deg, var(--brand-600), var(--brand-800));
      color: #fff;
      transition: transform .12s ease, filter .12s ease;
    }

    .btn:hover,
    button.btn:hover,
    .btn-link:hover { filter: brightness(1.05); transform: translateY(-1px); }

    .btn-sm { padding: 6px 10px; font-size: .82rem; border-radius: 8px; }
    .btn-secondary,
    .btn-outline-secondary {
      background: #fff;
      color: var(--ink-700);
      border-color: #cdd9eb;
    }
    .btn-outline-primary {
      background: #fff;
      color: var(--brand-700);
      border-color: #b9d0fb;
    }
    .btn-primary { background: linear-gradient(180deg, var(--brand-600), var(--brand-800)); color: #fff; }
    .btn-success { background: linear-gradient(180deg, #22c55e, #166534); color: #fff; }
    .btn-warning { background: linear-gradient(180deg, #f59e0b, #b45309); color: #fff; }
    .btn-danger { background: linear-gradient(180deg, #ef4444, #991b1b); color: #fff; }
    .btn-info { background: linear-gradient(180deg, #38bdf8, #0c4a6e); color: #fff; }

    .container,
    .container-fluid { width: 100%; }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .col-12,
    .col-md-4,
    .col-md-6,
    .col-md-8,
    .col-lg-6,
    .col-lg-8 {
      width: 100%;
      min-width: 0;
    }

    @media (min-width: 900px) {
      .col-md-4 { width: calc(33.333% - 8px); }
      .col-md-6 { width: calc(50% - 6px); }
      .col-md-8 { width: calc(66.666% - 8px); }
      .col-lg-6 { width: calc(50% - 6px); }
      .col-lg-8 { width: calc(66.666% - 8px); }
    }

    .text-end { text-align: right; }
    .text-center { text-align: center; }
    .text-white { color: #fff; }
    .text-dark { color: #111827; }
    .text-muted { color: var(--ink-500); }
    .small { font-size: .86rem; }

    .bg-light { background: #f8fbff; }
    .bg-success { background: #16a34a; }
    .bg-danger { background: #dc2626; }
    .bg-warning { background: #f59e0b; }
    .bg-info { background: #0ea5e9; }

    .w-100 { width: 100%; }
    .h-100 { height: 100%; }

    .mt-5 { margin-top: 2rem; }
    .mb-2 { margin-bottom: .5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-5 { margin-bottom: 1.5rem; }
    .py-5 { padding-top: 2rem; padding-bottom: 2rem; }

    .shadow-sm { box-shadow: var(--shadow-sm); }
    .border { border: 1px solid var(--line) !important; }
    .border-0 { border: 0 !important; }

    .table-responsive { width: 100%; overflow-x: auto; }
    .fs-4 { font-size: 1.35rem; font-weight: 700; }
    .hover-shadow:hover { box-shadow: var(--shadow-md); }

    @media (max-width: 1100px) {
      .menu-toggle { display: inline-block; }
      .sidebar { transform: translateX(-105%); }
      body.sidebar-open .sidebar { transform: translateX(0); }
      body.sidebar-open .sidebar-overlay { display: block; }
      .content {
        margin-left: 0;
        width: 100%;
        padding: 12px 12px 18px;
      }
      .topbar { position: static; }
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>
<body>
<div class="layout">
  <aside class="sidebar" id="sidebar-nav">
    <div class="brand">MUNDO LED ERP</div>

    <div class="menu-group">
      <div class="menu-title">Geral</div>
      <a class="menu-link" href="/">Painel Inicial</a>
      <a class="menu-link" href="/relatorios/">Relatórios</a>
    </div>

    <div class="menu-group">
      <div class="menu-title">Operações</div>
      <details class="menu-accordion" data-accordion-key="compras">
        <summary>Compras</summary>
        <div class="menu-children">
          <a class="menu-link" href="/compras/">Lista de compras</a>
          <a class="menu-link" href="/compras/aprovacoes/">Aprovação de compras</a>
          <a class="menu-link" href="/compras/novo/">Nova compra</a>
        </div>
      </details>

      <details class="menu-accordion" data-accordion-key="estoque">
        <summary>Estoque</summary>
        <div class="menu-children">
          <a class="menu-link" href="/estoque/">Dashboard de estoque</a>
          <a class="menu-link" href="/estoque/recebimentos/">Recebimento de mercadorias</a>
          <a class="menu-link" href="/estoque/movimentos/novo/">Movimentos de estoque</a>
          <a class="menu-link" href="/estoque/completo/">Estoque completo por unidade</a>
          <a class="menu-link" href="/estoque/contagem-rapida/">Contagem rápida por unidade</a>
          <a class="menu-link" href="/estoque/saidas-operacionais/">Saídas troca/garantia</a>
          <a class="menu-link" href="/estoque/transferencias/nova/">Transferências entre unidades</a>
        </div>
      </details>

      <details class="menu-accordion" data-accordion-key="vendas">
        <summary>Vendas</summary>
        <div class="menu-children">
          <a class="menu-link" href="/vendas/historico/">Histórico de vendas</a>
          <a class="menu-link" href="/vendas/nova/">Nova venda/orçamento</a>
          <a class="menu-link" href="/vendas/dashboard/">Dashboard de vendas</a>
          <a class="menu-link" href="/vendas/fechamentos/">Fechamento de caixa</a>
        </div>
      </details>

      <details class="menu-accordion" data-accordion-key="financeiro">
        <summary>Financeiro</summary>
        <div class="menu-children">
          <a class="menu-link" href="/contas/">Contas a pagar</a>
          <a class="menu-link" href="/financeiro/">Financeiro</a>
          <a class="menu-link" href="/boletos/">Boletos</a>
        </div>
      </details>

      <details class="menu-accordion" data-accordion-key="importadores">
        <summary>Importadores</summary>
        <div class="menu-children">
          <a class="menu-link" href="/importadores/caixa/importar/">Importar Caixa PDF</a>
          <a class="menu-link" href="/importadores/caixa/importacoes/">Histórico de importação</a>
        </div>
      </details>
    </div>

    <div class="menu-group">
      <div class="menu-title">Sistema</div>
      <a class="menu-link" href="/documentacao/">Documentação</a>
      <a class="menu-link" href="/admin/">Admin</a>
      <a class="menu-link" href="/accounts/logout/">Sair</a>
    </div>
  </aside>

  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <main class="content">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" id="js-sidebar-toggle" type="button">Menu</button>
        <strong>{% block page_title %}MUNDO LED ERP{% endblock %}</strong>
      </div>
      <span class="muted">Usuário: {% if request.user.is_authenticated %}{{ request.user.username }}{% else %}-{% endif %}</span>
    </div>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="msg {{ message.tags|default:'info' }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}
    <div class="card">
      <h2>Painel inicial</h2>
      <div class="grid" style="margin-top:12px;">
        <div class="tile">
          <h3>Compras</h3>
          <p class="muted">Compras, itens, garantias, anexos.</p>
          <a class="btn" href="/compras/">Abrir</a>
        </div>
        <div class="tile">
          <h3>Estoque</h3>
          <p class="muted">Movimentos, transferências e alertas.</p>
          <a class="btn" href="/estoque/">Abrir</a>
        </div>
        <div class="tile">
          <h3>Contas a pagar</h3>
          <p class="muted">Comprovantes, projeção e impostos.</p>
          <a class="btn" href="/contas/">Abrir</a>
        </div>
        <div class="tile">
          <h3>Boletos</h3>
          <p class="muted">Vendedores, anexos, lista negra e fiado.</p>
          <a class="btn" href="/boletos/">Abrir</a>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>Resultado do dia</h2>
      {% with rd=resultado_diario_dashboard %}
        {% if rd and rd.data_referencia %}
          <p class="muted">Base de cálculo em {{ rd.data_referencia|date:"d/m/Y" }} (ou última data disponível).</p>
          <table style="margin-top:10px;">
            <thead>
              <tr>
                <th>Unidade</th>
                <th>Vendas PDF</th>
                <th>Saídas Financeiro</th>
                <th>Resultado líquido</th>
              </tr>
            </thead>
            <tbody>
              {% for linha in rd.linhas %}
              <tr>
                <td>{{ linha.unidade|unit_label }}</td>
                <td>{{ linha.vendas|br_currency }}</td>
                <td>{{ linha.saidas|br_currency }}</td>
                <td><strong>{{ linha.resultado|br_currency }}</strong></td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td><strong>Consolidado</strong></td>
                <td><strong>{{ rd.total_vendas_geral|br_currency }}</strong></td>
                <td><strong>{{ rd.total_saidas_geral|br_currency }}</strong></td>
                <td><strong>{{ rd.resultado_geral|br_currency }}</strong></td>
              </tr>
            </tfoot>
          </table>
        {% else %}
          <p class="muted">Sem PDF de caixa importado ainda. Use "Importar Caixa PDF" no menu.</p>
        {% endif %}
      {% endwith %}
    </div>

    {% if alertas_operacionais %}
    <div class="card" style="margin-top:12px;">
      <h2>Alertas operacionais (admin)</h2>
      <p class="muted">Movimentações fora do padrão e descontos acima do limite de 10%.</p>
      <table style="margin-top:10px;">
        <thead>
          <tr>
            <th>Data</th>
            <th>Tipo</th>
            <th>Detalhe</th>
          </tr>
        </thead>
        <tbody>
          {% for alerta in alertas_operacionais %}
            <tr>
              <td>{{ alerta.data|date:"d/m/Y" }}</td>
              <td><strong>{{ alerta.tipo }}</strong></td>
              <td>{{ alerta.detalhe }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    {% endblock %}
  </main>
</div>

<script>
  (function () {
    var key = "erp_sidebar_accordion_state_v1";
    var pathname = window.location.pathname || "/";
    var body = document.body;
    var toggle = document.getElementById("js-sidebar-toggle");
    var overlay = document.getElementById("sidebar-overlay");
    var menuLinks = Array.prototype.slice.call(document.querySelectorAll(".menu-link[href]"));
    var accordions = Array.prototype.slice.call(document.querySelectorAll(".menu-accordion[data-accordion-key]"));

    if (toggle) {
      toggle.addEventListener("click", function () {
        body.classList.toggle("sidebar-open");
      });
    }

    if (overlay) {
      overlay.addEventListener("click", function () {
        body.classList.remove("sidebar-open");
      });
    }

    function linkIsActive(href) {
      if (!href) return false;
      if (href === "/") return pathname === "/";
      return pathname === href || pathname.indexOf(href) === 0;
    }

    menuLinks.forEach(function (link) {
      var href = link.getAttribute("href");
      if (linkIsActive(href)) {
        link.classList.add("active");
      }
      link.addEventListener("click", function () {
        body.classList.remove("sidebar-open");
      });
    });

    if (!accordions.length) return;

    var state = {};
    try {
      state = JSON.parse(localStorage.getItem(key) || "{}");
    } catch (err) {
      state = {};
    }

    function inferOpenByPath(acc) {
      var links = acc.querySelectorAll("a.menu-link[href]");
      for (var i = 0; i < links.length; i++) {
        var href = links[i].getAttribute("href");
        if (linkIsActive(href)) return true;
      }
      return false;
    }

    accordions.forEach(function (acc) {
      var accKey = acc.getAttribute("data-accordion-key");
      var shouldOpen = Object.prototype.hasOwnProperty.call(state, accKey) ? !!state[accKey] : inferOpenByPath(acc);
      acc.open = shouldOpen;
      acc.addEventListener("toggle", function () {
        state[accKey] = acc.open;
        localStorage.setItem(key, JSON.stringify(state));
      });
    });
  })();
</script>
</body>
</html>
