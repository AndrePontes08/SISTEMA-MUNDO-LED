{% extends "base.html" %}
{% load formatters %}
{% block title %}Estoque Completo{% endblock %}
{% block page_title %}Estoque Completo por Unidade{% endblock %}
{% block content %}
<style>
  .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 1px 10px rgba(0,0,0,.06); }
  table { width:100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:left; }
  .muted { color:#6b7280; font-size:13px; }
  .chip { padding:6px 10px; background:#f3f4f6; border-radius:999px; text-decoration:none; color:#111827; }
  .pager { margin-top: 12px; display:flex; gap:8px; align-items:center; }
</style>
<div class="card">
  <form method="get" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <input name="q" value="{{ request.GET.q }}" placeholder="Buscar produto..." style="padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; min-width:240px;">
    <button type="submit" style="padding:10px 12px; border-radius:10px; border:1px solid #111827;">Buscar</button>
  </form>

  <form method="post" enctype="multipart/form-data" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px;">
    {% csrf_token %}
    {{ import_form.arquivo }}
    <button type="submit" style="padding:10px 12px; border-radius:10px; border:1px solid #111827;">Importar custos CSV</button>
    <span class="muted">Colunas aceitas: `SKU` e `CUSTO_MEDIO` (ou `PRECO`).</span>
  </form>

  <table>
    <thead><tr><th>Produto</th><th>FM COMERCIO - UNIDADE 1</th><th>ML COMERCIO - UNIDADE 2</th><th>Total</th><th>Valor Unit√°rio</th><th>Valor FM</th><th>Valor ML</th><th>Valor Total</th><th>Atualizado</th></tr></thead>
    <tbody>
    {% for cfg in configs %}
      <tr>
        <td>{{ cfg.produto.nome }}</td>
        <td>{{ cfg.saldo_fm|br_number:0 }}</td>
        <td>{{ cfg.saldo_ml|br_number:0 }}</td>
        <td>{{ cfg.saldo_atual|br_number:0 }}</td>
        <td>{{ cfg.custo_medio|br_currency }}</td>
        <td>{{ cfg.valor_fm|br_currency }}</td>
        <td>{{ cfg.valor_ml|br_currency }}</td>
        <td><strong>{{ cfg.valor_total|br_currency }}</strong></td>
        <td>{{ cfg.atualizado_em|date:"d/m/Y H:i" }}</td>
      </tr>
    {% empty %}<tr><td colspan="9" class="muted">Nenhum registro.</td></tr>{% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="5"><strong>Totais</strong></td>
        <td><strong>{{ total_valor_fm|br_currency }}</strong></td>
        <td><strong>{{ total_valor_ml|br_currency }}</strong></td>
        <td><strong>{{ total_valor_geral|br_currency }}</strong></td>
        <td></td>
      </tr>
    </tfoot>
  </table>
  {% if is_paginated %}
    <div class="pager">
      {% if page_obj.has_previous %}<a class="chip" href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}">Anterior</a>{% endif %}
      <span class="muted">Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}<a class="chip" href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}">Proxima</a>{% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}
