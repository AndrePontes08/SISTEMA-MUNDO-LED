{% extends "base.html" %}
{% load formatters %}
{% block title %}Conciliação Bancária{% endblock %}
{% block page_title %}Conciliação Bancária{% endblock %}
{% block content %}
<div class="card">
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <a class="btn" href="{% url 'financeiro:conciliacao' %}">Atualizar</a>
    <a class="btn btn-secondary" href="{% url 'financeiro:importar_ofx' %}">Importar novo OFX</a>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Transação bancária</th>
          <th>Sugestões de recebíveis</th>
          <th>Status / Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in transacoes %}
        <tr>
          <td>
            <strong>#{{ tx.id }}</strong> {{ tx.data_lancamento }}<br>
            Conta: {{ tx.conta.nome }}<br>
            Descrição: {{ tx.descricao }}<br>
            Valor: <strong>{{ tx.valor }}</strong>
          </td>
          <td>
            {% with sugestoes=suggestions|get_item:tx.id %}
              {% if sugestoes %}
                {% for s in sugestoes %}
                  <label style="display:block;margin-bottom:4px">
                    <input type="checkbox" form="form-{{ tx.id }}" name="recebiveis" value="{{ s.recebivel_id }}">
                    #{{ s.recebivel_id }} - {{ s.data_prevista }} - {{ s.descricao }} - {{ s.valor }} (dif: {{ s.diferenca }})
                  </label>
                {% endfor %}
              {% else %}
                <span class="muted">Sem sugestões.</span>
              {% endif %}
            {% endwith %}
          </td>
          <td>
            <div><strong>{{ tx.status_conciliacao }}</strong></div>
            <form id="form-{{ tx.id }}" method="post" action="{% url 'financeiro:conciliacao_action' tx.id %}">
              {% csrf_token %}
              <input type="hidden" name="querystring" value="{{ querystring }}">
              <textarea name="observacao" rows="2" style="width:100%" placeholder="Observação"></textarea>
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">
                <button class="btn btn-sm" name="action" value="conciliar" type="submit">Conciliar</button>
                <button class="btn btn-sm" name="action" value="divergente" type="submit">Divergente</button>
                <button class="btn btn-sm btn-secondary" name="action" value="ignorar" type="submit">Ignorar</button>
              </div>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="3">Sem transações pendentes/sugeridas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
