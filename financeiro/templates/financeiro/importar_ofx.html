{% extends "base.html" %}
{% block title %}Importar OFX{% endblock %}
{% block page_title %}Importar OFX{% endblock %}
{% block content %}
<div class="card">
  <h2 style="margin-top:0;">1) Enviar arquivo OFX</h2>
  <p><a class="btn btn-secondary" href="{% url 'financeiro:conta_bancaria_create' %}?next={{ request.path }}">Cadastrar conta bancária</a></p>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="action" value="preview">
    <div id="drop-zone" style="border:2px dashed #94a3b8;border-radius:12px;padding:24px;text-align:center;background:#f8fafc;cursor:pointer;">
      <p><strong>Arraste o OFX aqui</strong> ou clique para selecionar.</p>
      {{ form.arquivo }}
    </div>
    <p style="margin-top:10px">{{ form.conta_bancaria.label_tag }} {{ form.conta_bancaria }}</p>
    <p class="muted">Se a conta não for detectada automaticamente, selecione manualmente.</p>
    <button class="btn" type="submit">Gerar prévia</button>
  </form>
</div>

{% if importacao_preview %}
<div class="card" style="margin-top:12px;">
  <h2 style="margin-top:0;">2) Prévia da importação #{{ importacao_preview.id }}</h2>
  <p>Conta detectada: {% if importacao_preview.conta %}<strong>{{ importacao_preview.conta }}</strong>{% else %}<strong>não detectada</strong>{% endif %}</p>
  <p>Período: {{ importacao_preview.periodo_inicio|default:"-" }} até {{ importacao_preview.periodo_fim|default:"-" }}</p>
  <p>Transações detectadas: {{ importacao_preview.transacoes_detectadas }}</p>
  {% if importacao_preview.alertas %}
    <ul>{% for alerta in importacao_preview.alertas %}<li>{{ alerta }}</li>{% endfor %}</ul>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-hover">
      <thead><tr><th>Data</th><th>Valor</th><th>Descrição</th><th>FITID</th></tr></thead>
      <tbody>
        {% for row in preview_rows %}
        <tr><td>{{ row.posted_at }}</td><td>{{ row.amount }}</td><td>{{ row.description }}</td><td>{{ row.fitid|default:"-" }}</td></tr>
        {% empty %}
        <tr><td colspan="4" class="muted">Sem transações para pré-visualizar.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <form method="post" style="margin-top:14px">
    {% csrf_token %}
    <input type="hidden" name="action" value="confirmar">
    <input type="hidden" name="importacao_id" value="{{ importacao_preview.id }}">
    <p>
      <label for="id_confirm_conta">Conta para confirmar:</label>
      <select name="conta_bancaria" id="id_confirm_conta">
        <option value="">Usar conta detectada</option>
        {% for conta in form.fields.conta_bancaria.queryset %}
          <option value="{{ conta.id }}" {% if importacao_preview.conta_id == conta.id %}selected{% endif %}>{{ conta }}</option>
        {% endfor %}
      </select>
    </p>
    <button class="btn" type="submit">Confirmar importação</button>
  </form>
</div>
{% endif %}

<script>
  (function () {
    const zone = document.getElementById("drop-zone");
    if (!zone) return;
    const input = zone.querySelector("input[type='file']");
    if (!input) return;
    input.style.display = "none";
    zone.addEventListener("click", () => input.click());
    zone.addEventListener("dragover", (e) => { e.preventDefault(); zone.style.borderColor = "#2563eb"; });
    zone.addEventListener("dragleave", () => { zone.style.borderColor = "#94a3b8"; });
    zone.addEventListener("drop", (e) => {
      e.preventDefault();
      zone.style.borderColor = "#94a3b8";
      if (e.dataTransfer.files.length) input.files = e.dataTransfer.files;
    });
  })();
</script>
{% endblock %}
