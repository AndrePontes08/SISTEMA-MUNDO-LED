{% extends "base.html" %}
{% load formatters %}

{% block title %}Dashboard de Vendas{% endblock %}
{% block page_title %}Dashboard de Vendas{% endblock %}

{% block content %}
<div class="card">
  <form method="get" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <label for="periodo"><strong>Período (dias)</strong></label>
    <input id="periodo" type="number" min="1" name="periodo" value="{{ request.GET.periodo|default:'30' }}" style="max-width:120px;">
    <button class="btn" type="submit">Atualizar</button>
  </form>

  <div class="db-grid" style="margin-top:12px;">
    <div class="db-kpi"><div class="muted">Período selecionado</div><div class="value">{{ dashboard.total_faturado|br_currency }}</div><div class="muted">{{ dashboard.total_vendas_faturadas }} vendas | ticket {{ dashboard.ticket_medio|br_currency }}</div></div>
    <div class="db-kpi"><div class="muted">Hoje</div><div class="value">{{ dashboard.resumo_dia.total_faturado|br_currency }}</div><div class="muted">{{ dashboard.resumo_dia.total_vendas }} vendas</div></div>
    <div class="db-kpi"><div class="muted">Mês</div><div class="value">{{ dashboard.resumo_mes.total_faturado|br_currency }}</div><div class="muted">{{ dashboard.resumo_mes.total_vendas }} vendas</div></div>
    <div class="db-kpi"><div class="muted">Ano</div><div class="value">{{ dashboard.resumo_ano.total_faturado|br_currency }}</div><div class="muted">{{ dashboard.resumo_ano.total_vendas }} vendas</div></div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <h2 style="margin-top:0;">Comparativo de faturamento</h2>
  <div class="bar-wrap">
    <div class="bar-line">
      <span class="muted">Dia</span>
      <div class="bar-track"><div class="bar-fill" style="width:{% widthratio dashboard.resumo_dia.total_faturado max_periodo 100 %}%"></div></div>
      <strong>{{ dashboard.resumo_dia.total_faturado|br_currency }}</strong>
    </div>
    <div class="bar-line">
      <span class="muted">Mês</span>
      <div class="bar-track"><div class="bar-fill" style="width:{% widthratio dashboard.resumo_mes.total_faturado max_periodo 100 %}%"></div></div>
      <strong>{{ dashboard.resumo_mes.total_faturado|br_currency }}</strong>
    </div>
    <div class="bar-line">
      <span class="muted">Ano</span>
      <div class="bar-track"><div class="bar-fill" style="width:{% widthratio dashboard.resumo_ano.total_faturado max_periodo 100 %}%"></div></div>
      <strong>{{ dashboard.resumo_ano.total_faturado|br_currency }}</strong>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <h2 style="margin-top:0;">Pico de vendas por horário</h2>
  <p class="muted">Maior índice: {{ dashboard.pico_horario.hora }}h ({{ dashboard.pico_horario.total }} vendas)</p>
  <div class="bar-wrap">
    {% for row in dashboard.vendas_por_hora %}
      <div class="bar-line">
        <span class="muted">{{ row.hora }}h</span>
        <div class="bar-track"><div class="bar-fill" style="width:{% widthratio row.total max_hora 100 %}%"></div></div>
        <strong>{{ row.total }}</strong>
      </div>
    {% endfor %}
  </div>
</div>

<div class="db-grid" style="margin-top:12px;">
  <div class="card">
    <h2 style="margin-top:0;">Top produtos</h2>
    <ul>
      {% for item in dashboard.top_produtos %}
        <li>{{ item.itens__produto__nome }} - qtd {{ item.quantidade }} - {{ item.total|br_currency }}</li>
      {% empty %}
        <li>Sem dados no período.</li>
      {% endfor %}
    </ul>
  </div>
  <div class="card">
    <h2 style="margin-top:0;">Top clientes</h2>
    <ul>
      {% for item in dashboard.top_clientes %}
        <li>{{ item.cliente__nome }} - {{ item.vendas }} venda(s) - {{ item.total|br_currency }}</li>
      {% empty %}
        <li>Sem dados no período.</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}
