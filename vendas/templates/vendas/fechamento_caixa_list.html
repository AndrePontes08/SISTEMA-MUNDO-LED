{% extends "base.html" %}
{% load formatters %}

{% block title %}Fechamento de Caixa{% endblock %}
{% block page_title %}Fechamento de Caixa Diário{% endblock %}

{% block content %}
<div class="card">
  <h2 style="margin-top:0;">Gerar fechamento diário</h2>
  <form method="post" action="{% url 'vendas:fechamento_caixa_gerar' %}" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px;">
    {% csrf_token %}
    <div>
      <label for="{{ form.data_referencia.id_for_label }}">Data de referência</label>
      {{ form.data_referencia }}
    </div>
    <div style="grid-column:1 / -1;">
      <label for="{{ form.observacoes.id_for_label }}">Observações</label>
      {{ form.observacoes }}
    </div>
    <div style="grid-column:1 / -1;">
      <button class="btn" type="submit">Gerar fechamento e PDF</button>
    </div>
  </form>
</div>

<div class="card" style="margin-top:12px;">
  <h2 style="margin-top:0;">Histórico de fechamentos</h2>
  <form method="get" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;margin:10px 0;">
    <div>
      <label for="id_data_referencia_filtro">Filtrar por data</label>
      <input id="id_data_referencia_filtro" type="date" name="data_referencia" value="{{ request.GET.data_referencia }}">
    </div>
    <button class="btn" type="submit">Filtrar</button>
    <a class="btn btn-secondary" href="{% url 'vendas:fechamento_caixa_list' %}">Limpar</a>
  </form>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Data</th>
          <th>Vendas</th>
          <th>Receita</th>
          <th>Descontos</th>
          <th>Totais por pagamento</th>
          <th>Gerado por</th>
          <th>Gerado em</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for fechamento in fechamentos %}
          <tr>
            <td>{{ fechamento.data_referencia|date:"d/m/Y" }}</td>
            <td>{{ fechamento.total_vendas }}</td>
            <td><strong>{{ fechamento.total_receita|br_currency }}</strong></td>
            <td>{{ fechamento.total_descontos|br_currency }}</td>
            <td>
              {% for pagamento, valor in fechamento.totais_por_pagamento.items %}
                <div>{{ pagamento }}: {{ valor|br_currency }}</div>
              {% empty %}
                -
              {% endfor %}
            </td>
            <td>{% if fechamento.criado_por %}{{ fechamento.criado_por.username }}{% else %}-{% endif %}</td>
            <td>{{ fechamento.criado_em|date:"d/m/Y H:i" }}</td>
            <td><a class="btn btn-sm" href="{% url 'vendas:fechamento_caixa_pdf' fechamento.pk %}">Baixar PDF</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="8">Nenhum fechamento encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      {% if page_obj.has_previous %}
        <a class="btn btn-secondary" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}
      <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn btn-secondary" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Próxima</a>
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}
