{% extends "base.html" %}
{% load formatters %}

{% block title %}{{ venda.codigo_identificacao }}{% endblock %}
{% block page_title %}{{ venda.codigo_identificacao }}{% endblock %}

{% block content %}
<div class="detail-grid">
  <div class="card">
    <h2 style="margin-top:0;">Resumo da venda</h2>
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
      <strong>{{ venda.codigo_identificacao }}</strong>
      <span class="status-pill {% if venda.status == 'RASCUNHO' %}status-rascunho{% elif venda.status == 'CONFIRMADA' %}status-confirmada{% elif venda.status == 'FATURADA' %}status-faturada{% elif venda.status == 'FINALIZADA' %}status-finalizada{% elif venda.status == 'CANCELADA' %}status-cancelada{% endif %}">{{ venda.get_status_display }}</span>
      <span class="muted">{{ venda.get_tipo_documento_display }}</span>
    </div>

    <div class="meta-list">
      <div class="meta-item"><strong>Cliente</strong><br>{{ venda.cliente.nome }}</div>
      <div class="meta-item"><strong>Data</strong><br>{{ venda.data_venda|date:"d/m/Y" }}</div>
      <div class="meta-item"><strong>Unidade</strong><br>{{ venda.unidade_saida|unit_label }}</div>
      <div class="meta-item"><strong>Vendedor</strong><br>{% if venda.vendedor %}{{ venda.vendedor.username }}{% else %}-{% endif %}</div>
      <div class="meta-item"><strong>Pagamento principal</strong><br>{{ venda.tipo_pagamento|payment_label }}</div>
      <div class="meta-item"><strong>Total final</strong><br><strong>{{ venda.total_final|br_currency }}</strong></div>
    </div>

    <h3 style="margin-top:14px;">Composição de pagamentos</h3>
    <ul class="clean-list">
      {% for pg in venda.pagamentos_para_exibicao %}
        <li>{{ pg.tipo_pagamento|payment_label }}: {{ pg.valor|br_currency }}</li>
      {% empty %}
        <li>{{ venda.tipo_pagamento|payment_label }}: {{ venda.total_final|br_currency }}</li>
      {% endfor %}
    </ul>

    <h3 style="margin-top:14px;">Itens</h3>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd</th>
            <th>Unitário</th>
            <th>Desconto</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for item in venda.itens.all %}
          <tr>
            <td>{{ item.produto.nome }}</td>
            <td>{{ item.quantidade|br_number:0 }}</td>
            <td>{{ item.preco_unitario|br_currency }}</td>
            <td>{{ item.desconto|br_currency }}</td>
            <td><strong>{{ item.subtotal|br_currency }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div>
    <div class="card">
      <h2 style="margin-top:0;">Ações</h2>
      <div style="display:grid; gap:8px;">
        <a class="btn" href="{% url 'vendas:venda_pdf' venda.pk %}">Imprimir PDF</a>
        {% if venda.status == "RASCUNHO" or venda.status == "CONFIRMADA" %}
          <a class="btn btn-secondary" href="{% url 'vendas:venda_update' venda.pk %}">Editar</a>
        {% endif %}
        {% if venda.is_orcamento and venda.status != "CANCELADA" %}
          <form method="post" action="{% url 'vendas:orcamento_converter' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Converter em venda</button></form>
        {% endif %}
        {% if venda.status == "RASCUNHO" %}
          <form method="post" action="{% url 'vendas:venda_confirmar' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Confirmar venda</button></form>
        {% endif %}
        {% if venda.status == "CONFIRMADA" and not venda.is_orcamento %}
          <form method="post" action="{% url 'vendas:venda_faturar' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Faturar venda</button></form>
        {% endif %}
        {% if venda.status == "FATURADA" %}
          <form method="post" action="{% url 'vendas:venda_finalizar' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Finalizar venda</button></form>
        {% endif %}
      </div>

      {% if venda.status != "CANCELADA" %}
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e6edf8;">
          <form method="post" action="{% url 'vendas:venda_cancelar' venda.pk %}" style="display:grid;gap:8px;">
            {% csrf_token %}
            <label for="{{ cancelar_form.motivo.id_for_label }}"><strong>Motivo do cancelamento</strong></label>
            {{ cancelar_form.motivo }}
            <button class="btn btn-danger" type="submit">Cancelar venda</button>
          </form>
        </div>
      {% endif %}
    </div>

    <div class="card" style="margin-top:12px;">
      <h2 style="margin-top:0;">Recebíveis</h2>
      <ul class="clean-list">
        {% for link in venda.recebiveis.all %}
          <li>Parcela {{ link.numero_parcela }} - {{ link.valor|br_currency }} - {{ link.recebivel.status }} - {{ link.data_vencimento|date:"d/m/Y" }}</li>
        {% empty %}
          <li>Sem recebíveis.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2 style="margin-top:0;">Boletos</h2>
      <ul class="clean-list">
        {% for link in venda.boletos.all %}
          <li>{{ link.boleto.numero_boleto }} - {{ link.boleto.status }} - {{ link.boleto.valor|br_currency }}</li>
        {% empty %}
          <li>Sem boletos.</li>
        {% endfor %}
      </ul>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2 style="margin-top:0;">Histórico</h2>
      <ul class="clean-list">
        {% for evento in venda.eventos.all %}
          <li>{{ evento.criado_em|date:"d/m/Y H:i" }} - {{ evento.get_tipo_display }} - {{ evento.detalhe }}</li>
        {% empty %}
          <li>Sem eventos.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>
{% endblock %}
