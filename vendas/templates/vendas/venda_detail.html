{% extends "base.html" %}

{% block title %}{{ venda.codigo_identificacao }}{% endblock %}
{% block page_title %}{{ venda.codigo_identificacao }}{% endblock %}

{% block content %}
<div class="card">
  <p><strong>Codigo:</strong> {{ venda.codigo_identificacao }}</p>
  <p><strong>Cliente:</strong> {{ venda.cliente.nome }}</p>
  <p><strong>Data:</strong> {{ venda.data_venda|date:"d/m/Y" }}</p>
  <p><strong>Unidade de saida:</strong> {{ venda.get_unidade_saida_display }}</p>
  <p><strong>Tipo:</strong> {{ venda.get_tipo_documento_display }}</p>
  <p><strong>Status:</strong> {{ venda.get_status_display }}</p>
  <p><strong>Pagamento:</strong> {{ venda.get_tipo_pagamento_display }}</p>
  <p><strong>Total:</strong> R$ {{ venda.total_final }}</p>

  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0;">
    <a class="btn" href="{% url 'vendas:venda_pdf' venda.pk %}">Imprimir PDF</a>
    {% if venda.status == "RASCUNHO" or venda.status == "CONFIRMADA" %}
      <a class="btn" href="{% url 'vendas:venda_update' venda.pk %}">Editar</a>
    {% endif %}
    {% if venda.is_orcamento and venda.status != "CANCELADA" %}
      <form method="post" action="{% url 'vendas:orcamento_converter' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Converter em venda</button></form>
    {% endif %}
    {% if venda.status == "RASCUNHO" %}
      <form method="post" action="{% url 'vendas:venda_confirmar' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Confirmar</button></form>
    {% endif %}
    {% if venda.status == "CONFIRMADA" and not venda.is_orcamento %}
      <form method="post" action="{% url 'vendas:venda_faturar' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Faturar</button></form>
    {% endif %}
    {% if venda.status == "FATURADA" %}
      <form method="post" action="{% url 'vendas:venda_finalizar' venda.pk %}">{% csrf_token %}<button class="btn" type="submit">Finalizar</button></form>
    {% endif %}
  </div>

  {% if venda.status != "CANCELADA" %}
  <div style="margin-top:12px;padding:12px;border-radius:10px;background:#f8fafc;border:1px solid #e2e8f0;">
    <form method="post" action="{% url 'vendas:venda_cancelar' venda.pk %}" style="display:grid;gap:8px;">
      {% csrf_token %}
      <label for="{{ cancelar_form.motivo.id_for_label }}"><strong>Motivo do cancelamento</strong></label>
      {{ cancelar_form.motivo }}
      <div><button class="btn" type="submit">Cancelar venda</button></div>
    </form>
  </div>
  {% endif %}
</div>

<div class="card" style="margin-top:12px;">
  <h2>Itens</h2>
  <table style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Produto</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Qtd</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Unitario</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Desconto</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for item in venda.itens.all %}
      <tr>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item.produto.nome }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item.quantidade }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item.preco_unitario }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item.desconto }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item.subtotal }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Historico</h2>
  <ul>
    {% for evento in venda.eventos.all %}
      <li>{{ evento.criado_em|date:"d/m/Y H:i" }} - {{ evento.get_tipo_display }} - {{ evento.detalhe }}</li>
    {% empty %}
      <li>Sem eventos.</li>
    {% endfor %}
  </ul>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Financeiro</h2>
  <ul>
    {% for link in venda.recebiveis.all %}
      <li>Parcela {{ link.numero_parcela }} - R$ {{ link.valor }} - {{ link.recebivel.status }} - {{ link.data_vencimento|date:"d/m/Y" }}</li>
    {% empty %}
      <li>Sem recebiveis.</li>
    {% endfor %}
  </ul>
</div>

<div class="card" style="margin-top:12px;">
  <h2>Boletos</h2>
  <ul>
    {% for link in venda.boletos.all %}
      <li>{{ link.boleto.numero_boleto }} - {{ link.boleto.status }} - R$ {{ link.boleto.valor }}</li>
    {% empty %}
      <li>Sem boletos.</li>
    {% endfor %}
  </ul>
</div>
{% endblock %}
