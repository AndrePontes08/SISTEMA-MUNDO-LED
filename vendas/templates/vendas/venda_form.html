{% extends "base.html" %}

{% block title %}Venda{% endblock %}
{% block page_title %}Venda / Orçamento{% endblock %}

{% block content %}
<div class="card">
  <form method="post" id="venda-form">
    {% csrf_token %}
    <h2>Dados principais</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
      <div>
        <label for="{{ form.tipo_documento.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.tipo_documento.label }}</label>
        {{ form.tipo_documento }}
      </div>
      <div>
        <label for="{{ form.cliente.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.cliente.label }}</label>
        {{ form.cliente }}
      </div>
      <div>
        <label for="{{ form.vendedor.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.vendedor.label }}</label>
        {{ form.vendedor }}
      </div>
      <div>
        <label for="{{ form.unidade_saida.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.unidade_saida.label }}</label>
        {{ form.unidade_saida }}
      </div>
      <div>
        <label for="{{ form.data_venda.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.data_venda.label }}</label>
        {{ form.data_venda.as_hidden }}
        <input type="text" value="{% now 'd/m/Y' %}" readonly style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#f9fafb;">
      </div>
      <div>
        <label for="{{ form.tipo_pagamento.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.tipo_pagamento.label }}</label>
        {{ form.tipo_pagamento }}
        <small class="muted">Forma principal da venda (usada como referência).</small>
      </div>
      <div id="field-numero-parcelas">
        <label for="{{ form.numero_parcelas.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.numero_parcelas.label }}</label>
        {{ form.numero_parcelas }}
      </div>
      <div id="field-intervalo-parcelas">
        <label for="{{ form.intervalo_parcelas_dias.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.intervalo_parcelas_dias.label }}</label>
        {{ form.intervalo_parcelas_dias }}
      </div>
      <div id="field-primeiro-vencimento">
        <label for="{{ form.primeiro_vencimento.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.primeiro_vencimento.label }}</label>
        {{ form.primeiro_vencimento }}
      </div>
      <div id="field-acrescimo">
        <label for="{{ form.acrescimo.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.acrescimo.label }}</label>
        {{ form.acrescimo }}
      </div>
      <div style="grid-column:1 / -1;">
        <label for="{{ form.observacoes.id_for_label }}" style="display:block;font-weight:600;margin-bottom:4px;">{{ form.observacoes.label }}</label>
        {{ form.observacoes }}
      </div>
      <div style="grid-column:1 / -1;">
        <label style="display:block;font-weight:600;margin-bottom:6px;">Formas de pagamento da venda</label>
        <p class="muted" style="margin:0 0 8px 0;">A soma das formas deve ser igual ao total final da venda.</p>
        <table style="width:100%;border-collapse:collapse;" id="pagamentos-table">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Forma de pagamento</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Valor (R$)</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Ação</th>
            </tr>
          </thead>
          <tbody id="pagamentos-body">
            {% for tipo_val, valor_val in pagamentos_rows %}
              <tr class="pagamento-row">
                <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
                  <select name="pagamentos_tipo" style="width:100%;">
                    <option value="">Selecione</option>
                    {% for opt_val, opt_label in tipo_pagamento_choices %}
                      <option value="{{ opt_val }}" {% if tipo_val == opt_val %}selected{% endif %}>{{ opt_label }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
                  <input type="number" step="0.01" min="0" name="pagamentos_valor" value="{{ valor_val }}" style="width:100%;">
                </td>
                <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
                  <button type="button" class="btn js-remove-pagamento">Remover</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div style="margin-top:8px;">
          <button class="btn" type="button" id="add-pagamento-btn">Adicionar forma de pagamento</button>
        </div>
      </div>
    </div>
    {% if form.non_field_errors %}
      <div class="msg error" style="margin-top:10px;">{{ form.non_field_errors|striptags }}</div>
    {% endif %}

    <h3 style="margin-top:18px;">Itens da venda / orçamento</h3>
    <p class="muted">Adicione quantos produtos forem necessários. O desconto por item é percentual (%). Acima de 10% exige autorização de administrador/gerente.</p>
    {{ itens_formset.management_form }}
    <table style="width:100%;border-collapse:collapse;" id="itens-table">
      <thead>
        <tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Produto</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Quantidade</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Preco unitario</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Desconto (%)</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Acao</th>
        </tr>
      </thead>
      <tbody id="itens-body">
        {% for item_form in itens_formset %}
          <tr class="item-row">
            <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item_form.produto }}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item_form.quantidade }}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item_form.preco_unitario }}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ item_form.desconto }}</td>
            <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
              <button type="button" class="btn js-remove-row">Remover</button>
              <span style="display:none;">{{ item_form.DELETE }}</span>
              {% for hidden in item_form.hidden_fields %}{{ hidden }}{% endfor %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <template id="empty-item-template">
      <tr class="item-row">
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ empty_item_form.produto }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ empty_item_form.quantidade }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ empty_item_form.preco_unitario }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ empty_item_form.desconto }}</td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
          <button type="button" class="btn js-remove-row">Remover</button>
          <span style="display:none;">{{ empty_item_form.DELETE }}</span>
          {% for hidden in empty_item_form.hidden_fields %}{{ hidden }}{% endfor %}
        </td>
      </tr>
    </template>

    <template id="empty-pagamento-template">
      <tr class="pagamento-row">
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
          <select name="pagamentos_tipo" style="width:100%;">
            <option value="">Selecione</option>
            {% for opt_val, opt_label in tipo_pagamento_choices %}
              <option value="{{ opt_val }}">{{ opt_label }}</option>
            {% endfor %}
          </select>
        </td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
          <input type="number" step="0.01" min="0" name="pagamentos_valor" style="width:100%;">
        </td>
        <td style="padding:8px;border-bottom:1px solid #e5e7eb;">
          <button type="button" class="btn js-remove-pagamento">Remover</button>
        </td>
      </tr>
    </template>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn" type="button" id="add-item-btn">Adicionar produto</button>
      <button class="btn" type="submit">Salvar</button>
      <a class="btn" href="{% url 'vendas:venda_list' %}">Voltar</a>
    </div>

    <div style="margin-top:14px;padding:12px;border:1px solid #e5e7eb;border-radius:10px;">
      <strong>Autorização de desconto acima de 10%</strong>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:8px;">
        <div>
          <label for="id_desconto_autorizador" style="display:block;font-weight:600;margin-bottom:4px;">Usuário autorizador</label>
          <input id="id_desconto_autorizador" name="desconto_autorizador" type="text" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;">
        </div>
        <div>
          <label for="id_desconto_senha" style="display:block;font-weight:600;margin-bottom:4px;">Senha do autorizador</label>
          <input id="id_desconto_senha" name="desconto_senha" type="password" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;">
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  (function () {
    const body = document.getElementById("itens-body");
    const addBtn = document.getElementById("add-item-btn");
    const totalForms = document.getElementById("id_itens-TOTAL_FORMS");
    const template = document.getElementById("empty-item-template");
    const pagamentosBody = document.getElementById("pagamentos-body");
    const pagamentoTemplate = document.getElementById("empty-pagamento-template");
    const addPagamentoBtn = document.getElementById("add-pagamento-btn");

    function bindRemove(btn) {
      btn.addEventListener("click", function () {
        const row = btn.closest(".item-row");
        if (!row) return;
        const deleteInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
        if (deleteInput) {
          deleteInput.checked = true;
        }
        row.style.display = "none";
      });
    }

    body.querySelectorAll(".js-remove-row").forEach(bindRemove);

    addBtn.addEventListener("click", function () {
      const idx = parseInt(totalForms.value, 10);
      const html = template.innerHTML.replaceAll("__prefix__", String(idx));
      const wrapper = document.createElement("tbody");
      wrapper.innerHTML = html.trim();
      const row = wrapper.querySelector(".item-row");
      body.appendChild(row);
      bindRemove(row.querySelector(".js-remove-row"));
      totalForms.value = String(idx + 1);
    });

    const tipoPagamento = document.getElementById("id_tipo_pagamento");
    const boletoFields = [
      document.getElementById("field-numero-parcelas"),
      document.getElementById("field-intervalo-parcelas"),
      document.getElementById("field-primeiro-vencimento"),
      document.getElementById("field-acrescimo")
    ];

    function hasBoletoInRows() {
      const selects = pagamentosBody ? pagamentosBody.querySelectorAll('select[name="pagamentos_tipo"]') : [];
      for (const sel of selects) {
        if (sel.value === "PARCELADO_BOLETO") return true;
      }
      return false;
    }

    function toggleBoletoFields() {
      const isBoleto = (tipoPagamento && tipoPagamento.value === "PARCELADO_BOLETO") || hasBoletoInRows();
      boletoFields.forEach(function (el) {
        if (!el) return;
        el.style.display = isBoleto ? "block" : "none";
      });
    }

    function bindPagamentoRemove(btn) {
      btn.addEventListener("click", function () {
        const row = btn.closest(".pagamento-row");
        if (row) {
          row.remove();
          toggleBoletoFields();
        }
      });
    }

    if (tipoPagamento) {
      tipoPagamento.addEventListener("change", toggleBoletoFields);
      toggleBoletoFields();
    }

    if (pagamentosBody) {
      pagamentosBody.querySelectorAll(".js-remove-pagamento").forEach(bindPagamentoRemove);
      pagamentosBody.querySelectorAll('select[name="pagamentos_tipo"]').forEach(function (sel) {
        sel.addEventListener("change", toggleBoletoFields);
      });
    }

    if (addPagamentoBtn && pagamentoTemplate && pagamentosBody) {
      addPagamentoBtn.addEventListener("click", function () {
        const wrapper = document.createElement("tbody");
        wrapper.innerHTML = pagamentoTemplate.innerHTML.trim();
        const row = wrapper.querySelector(".pagamento-row");
        pagamentosBody.appendChild(row);
        const removeBtn = row.querySelector(".js-remove-pagamento");
        if (removeBtn) bindPagamentoRemove(removeBtn);
        const select = row.querySelector('select[name="pagamentos_tipo"]');
        if (select) {
          select.addEventListener("change", toggleBoletoFields);
        }
        toggleBoletoFields();
      });
    }
  })();
</script>
{% endblock %}
