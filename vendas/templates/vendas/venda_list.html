{% extends "base.html" %}
{% load formatters %}

{% block title %}Histórico de Vendas{% endblock %}
{% block page_title %}Histórico de Vendas{% endblock %}

{% block content %}
<div class="card">
  <h2 style="margin-top:0;">Filtro de vendas</h2>
  <form method="get" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:12px;">
    <input type="text" name="cliente" placeholder="Cliente" value="{{ request.GET.cliente }}">
    <input type="text" name="vendedor" placeholder="Vendedor (usuário)" value="{{ request.GET.vendedor }}">
    <select name="tipo_documento">
      <option value="">Venda e orçamento</option>
      {% for value, label in tipo_documento_choices %}
        <option value="{{ value }}" {% if request.GET.tipo_documento == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="status">
      <option value="">Todos os status</option>
      {% for value, label in status_choices %}
        <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="tipo_pagamento">
      <option value="">Todas as formas de pagamento</option>
      {% for value, label in tipo_pagamento_choices %}
        <option value="{{ value }}" {% if request.GET.tipo_pagamento == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <input type="date" name="data_inicio" value="{{ request.GET.data_inicio }}">
    <input type="date" name="data_fim" value="{{ request.GET.data_fim }}">
    <button class="btn" type="submit">Filtrar</button>
    <a class="btn btn-secondary" href="{% url 'vendas:venda_historico' %}">Limpar</a>
    <a class="btn" href="{% url 'vendas:venda_create' %}">+ Nova venda</a>
  </form>

  <div class="sales-kpis">
    <div class="sales-kpi"><div class="muted">Vendas no filtro</div><div class="value">{{ resumo_filtrado.total_vendas }}</div></div>
    <div class="sales-kpi"><div class="muted">Total no filtro</div><div class="value">{{ resumo_filtrado.total_final|br_currency }}</div></div>
    <div class="sales-kpi"><div class="muted">Descontos no filtro</div><div class="value">{{ resumo_filtrado.total_descontos|br_currency }}</div></div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Código</th>
          <th>Data</th>
          <th>Tipo</th>
          <th>Cliente</th>
          <th>Vendedor</th>
          <th>Itens</th>
          <th>Status</th>
          <th>Total</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for venda in vendas %}
          <tr>
            <td><a href="{% url 'vendas:venda_detail' venda.pk %}"><strong>{{ venda.codigo_identificacao }}</strong></a><br><span class="muted">{{ venda.unidade_saida|unit_label }}</span></td>
            <td>{{ venda.data_venda|date:"d/m/Y" }}</td>
            <td>{{ venda.get_tipo_documento_display }}</td>
            <td>{{ venda.cliente.nome }}</td>
            <td>{% if venda.vendedor %}{{ venda.vendedor.username }}{% else %}-{% endif %}</td>
            <td>
              <span class="muted">{{ venda.itens.count }} item(ns)</span>
              <ul class="items-mini">
                {% for item in venda.itens.all|slice:":2" %}
                  <li>{{ item.produto.nome }} ({{ item.quantidade|br_number:0 }})</li>
                {% endfor %}
              </ul>
            </td>
            <td>
              <span class="status-pill {% if venda.status == 'RASCUNHO' %}status-rascunho{% elif venda.status == 'CONFIRMADA' %}status-confirmada{% elif venda.status == 'FATURADA' %}status-faturada{% elif venda.status == 'FINALIZADA' %}status-finalizada{% elif venda.status == 'CANCELADA' %}status-cancelada{% endif %}">
                {{ venda.get_status_display }}
              </span>
            </td>
            <td><strong>{{ venda.total_final|br_currency }}</strong><br><span class="muted">{{ venda.tipo_pagamento|payment_label }}</span></td>
            <td class="actions-col">
              <a class="btn btn-sm" href="{% url 'vendas:venda_detail' venda.pk %}">Abrir</a>
              {% if venda.status == "RASCUNHO" or venda.status == "CONFIRMADA" %}
                <a class="btn btn-sm btn-secondary" href="{% url 'vendas:venda_update' venda.pk %}">Editar</a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9">Nenhuma venda encontrada para os filtros aplicados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      {% if page_obj.has_previous %}
        <a class="btn btn-secondary" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}
      <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn btn-secondary" href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}">Próxima</a>
      {% endif %}
    </div>
  {% endif %}
</div>

<div class="card" style="margin-top:12px;">
  <h2 style="margin-top:0;">Resumo rápido</h2>
  <div class="sales-kpis" style="margin-top:8px; margin-bottom:0;">
    <div class="sales-kpi"><div class="muted">Total faturado</div><div class="value">{{ dashboard.total_faturado|br_currency }}</div></div>
    <div class="sales-kpi"><div class="muted">Vendas faturadas</div><div class="value">{{ dashboard.total_vendas_faturadas }}</div></div>
    <div class="sales-kpi"><div class="muted">Ticket médio</div><div class="value">{{ dashboard.ticket_medio|br_currency }}</div></div>
  </div>
</div>
{% endblock %}
