{% extends "base.html" %}

{% block title %}Vendas{% endblock %}
{% block page_title %}Vendas{% endblock %}

{% block content %}
<div class="card">
  <h2>Listagem de Vendas</h2>
  <form method="get" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:12px 0;">
    <input type="text" name="cliente" placeholder="Cliente" value="{{ request.GET.cliente }}">
    <select name="tipo_documento">
      <option value="">Venda e Orcamento</option>
      {% for value, label in tipo_documento_choices %}
        <option value="{{ value }}" {% if request.GET.tipo_documento == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <select name="status">
      <option value="">Todos os status</option>
      {% for value, label in status_choices %}
        <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <input type="date" name="data_inicio" value="{{ request.GET.data_inicio }}">
    <input type="date" name="data_fim" value="{{ request.GET.data_fim }}">
    <button class="btn" type="submit">Filtrar</button>
    <a class="btn" href="{% url 'vendas:venda_create' %}">Nova venda</a>
  </form>

  <table style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Codigo</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Data</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Tipo</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Unidade</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Cliente</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Itens</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Status</th>
        <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">Total</th>
      </tr>
    </thead>
    <tbody>
      {% for venda in vendas %}
        <tr>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;"><a href="{% url 'vendas:venda_detail' venda.pk %}">{{ venda.codigo_identificacao }}</a></td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ venda.data_venda|date:"d/m/Y" }}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ venda.get_tipo_documento_display }}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ venda.get_unidade_saida_display }}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ venda.cliente.nome }}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;min-width:320px;">
            <table style="width:100%;border-collapse:collapse;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;">
              <thead>
                <tr>
                  <th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Produto</th>
                  <th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb;">Qtd</th>
                  <th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb;">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for item in venda.itens.all|slice:":4" %}
                  <tr>
                    <td style="padding:6px;border-bottom:1px solid #eef2f7;">{{ item.produto.nome }}</td>
                    <td style="padding:6px;text-align:right;border-bottom:1px solid #eef2f7;">{{ item.quantidade }}</td>
                    <td style="padding:6px;text-align:right;border-bottom:1px solid #eef2f7;">R$ {{ item.subtotal }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="3" style="padding:6px;">Sem itens</td></tr>
                {% endfor %}
              </tbody>
            </table>
            {% if venda.itens.count > 4 %}
              <div class="muted" style="margin-top:4px;">+ {{ venda.itens.count|add:"-4" }} item(ns)</div>
            {% endif %}
          </td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">{{ venda.get_status_display }}</td>
          <td style="padding:8px;border-bottom:1px solid #e5e7eb;">R$ {{ venda.total_final }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="8" style="padding:10px;">Nenhuma venda encontrada.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if is_paginated %}
    <div style="margin-top:12px;">
      {% if page_obj.has_previous %}
        <a class="btn" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}
      <span style="margin:0 8px;">Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn" href="?page={{ page_obj.next_page_number }}">Proxima</a>
      {% endif %}
    </div>
  {% endif %}
</div>

<div class="card" style="margin-top:12px;">
  <h2>Dashboard rapido</h2>
  <div class="grid">
    <div class="tile"><strong>Total faturado</strong><br>R$ {{ dashboard.total_faturado }}</div>
    <div class="tile"><strong>Vendas faturadas</strong><br>{{ dashboard.total_vendas_faturadas }}</div>
    <div class="tile"><strong>Ticket medio</strong><br>R$ {{ dashboard.ticket_medio }}</div>
  </div>
</div>
{% endblock %}
